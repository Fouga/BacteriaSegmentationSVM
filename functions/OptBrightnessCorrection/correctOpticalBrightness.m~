function CorrectionTable = correctOpticalBrightness(source_dir,save_dir)


paramFile=getTiledAcquisitionParamFile;
OBJECT=returnSystemSpecificClass;
param = readMosaicMetaData(OBJECT,paramFile,1);

% if ~exist(save_dir)
%     mkdir(save_dir)
% end
for chan = 1:param.channels
    % build needed image brightness from the 1 optical section
    source = [source_dir sprintf('%i/',chan) sprintf('*_0%i.tif',1)];
    [Model_needed, options] = getCorrectionModel(source, save_dir,1);
    OptSec = 1;
    ratio = 1;
    Channel = chan;
    CorrectionTable = table(OptSec,ratio,Channel);
    options.Opticalmethod = 'average';
    for optS =2:param.layers
        source = [source_dir sprintf('*_0%i.tif',optS)];
        % 
        Model_change = getCorrectionModel(source, save_dir,optS);

        ratio = correctImages(source, save_dir, Model_needed, Model_change, options);
        OptSec = optS;
        CorrectionTableRa = table(OptSec,ratio,Channel);
        CorrectionTableChan = [CorrectionTableChan; CorrectionTable2]

    end
    CorrectionTable = [CorrectionTable, CorrectionTable]
    writetable(CorrectionTable,[save_dir 'BrightnessCorrection.txt']);
    options.BrightnessCorrecitonFilename =  [save_dir 'BrightnessCorrection.txt'];      
end

